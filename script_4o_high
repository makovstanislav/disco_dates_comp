/**
 * Office Script: synchronize dates from “GFE” to “Main” and flag changes.
 *
 * • Starts at row 3 (0-based index 2).
 * • Copies FA/Disco dates into Main cols E/F.
 * • Writes “Y” in Main cols G/H if dates differ.
 * • All variables, loop indices, and function parameters have explicit types.
 */

// Normalize any cell value to a primitive (string or number) for comparison
function normalizeValue(value: ExcelScript.CellValue): string | number {
  if (value === "" || value === null || value === undefined) {
    return "";
  }
  if (typeof value === "number") {
    return value;
  }
  if (value instanceof Date) {
    return value.getTime();
  }
  return String(value).trim();
}

// Compare two cell values (as dates or blanks)
function datesEqualValue(a: ExcelScript.CellValue, b: ExcelScript.CellValue): boolean {
  const normA: string | number = normalizeValue(a);
  const normB: string | number = normalizeValue(b);
  return normA === normB;
}

// Main entry point
function main(workbook: ExcelScript.Workbook): void {
  // Starting row (0-based index, so row 3 in Excel)
  const START_ROW: number = 2;

  // Worksheets
  const wsMain: ExcelScript.Worksheet = workbook.getWorksheet("Main") as ExcelScript.Worksheet;
  const wsGFE: ExcelScript.Worksheet = workbook.getWorksheet("GFE") as ExcelScript.Worksheet;

  // Read GFE data
  const gfeRange: ExcelScript.Range = wsGFE.getUsedRange() as ExcelScript.Range;
  const gfeData: ExcelScript.CellValue[][] = gfeRange.getValues() as ExcelScript.CellValue[][];

  // Lookup table for GFE dates
  interface DatesPair { fa: ExcelScript.CellValue; disco: ExcelScript.CellValue; }
  const lookup: Record<string, DatesPair> = {};

  for (let rowIndex: number = START_ROW; rowIndex < gfeData.length; rowIndex++) {
    const materialKey: string = String(gfeData[rowIndex][0]);
    const seasonKey: string = String(gfeData[rowIndex][1]);
    if (materialKey === "" || seasonKey === "") {
      continue;
    }
    const key: string = `${materialKey}|${seasonKey}`;
    lookup[key] = {
      fa: gfeData[rowIndex][2],
      disco: gfeData[rowIndex][3]
    };
  }

  // Read Main data
  const mainRange: ExcelScript.Range = wsMain.getUsedRange() as ExcelScript.Range;
  const mainData: ExcelScript.CellValue[][] = mainRange.getValues() as ExcelScript.CellValue[][];

  // Iterate Main rows and update
  for (let rowIndex: number = START_ROW; rowIndex < mainData.length; rowIndex++) {
    const materialKey: string = String(mainData[rowIndex][0]);
    const seasonKey: string = String(mainData[rowIndex][1]);
    if (materialKey === "" || seasonKey === "") {
      continue;
    }
    const key: string = `${materialKey}|${seasonKey}`;
    const dates: DatesPair | undefined = lookup[key];
    if (!dates) {
      continue; // no matching key in GFE
    }

    // Copy dates into Main cols E (index 4) and F (index 5)
    mainData[rowIndex][4] = dates.fa;
    mainData[rowIndex][5] = dates.disco;

    // Flag First Available change in G (index 6)
    if (!datesEqualValue(mainData[rowIndex][2], dates.fa)) {
      mainData[rowIndex][6] = "Y";
    }
    // Flag Discontinue change in H (index 7)
    if (!datesEqualValue(mainData[rowIndex][3], dates.disco)) {
      mainData[rowIndex][7] = "Y";
    }
  }

  // Write updated values back to Main sheet
  mainRange.setValues(mainData);
}
